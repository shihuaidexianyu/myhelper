{% extends "base.html" %}

{% block title %}工具配置 - MyHelper{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-tools"></i> 工具配置</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#toolModal" onclick="editTool()">
        <i class="fas fa-plus"></i> 新增工具
    </button>
</div>

{% if tools %}
<div class="row">
    {% for tool_id, tool in tools.items() %}
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{ tool.name }}</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="editTool('{{ tool_id }}', {{ tool|tojson|safe }})">
                        <i class="fas fa-edit"></i> 编辑
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTool('{{ tool_id }}')">
                        <i class="fas fa-trash"></i> 删除
                    </button>
                </div>
            </div>
            <div class="card-body">
                <p class="text-muted small">ID: {{ tool_id }}</p>
                <p class="card-text">{{ tool.description }}</p>
                <div class="mt-3">
                    <h6>命令模板:</h6>
                    <code class="d-block p-2 bg-light rounded">{{ tool.command_template }}</code>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-info">
    <i class="fas fa-info-circle"></i> 还没有配置工具，<button class="btn btn-link p-0" data-bs-toggle="modal" data-bs-target="#toolModal" onclick="editTool()">点击这里添加第一个工具</button>
</div>
{% endif %}

<!-- 工具编辑模态框 -->
<div class="modal fade" id="toolModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="toolModalTitle">新增工具</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('web.save_tool') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="tool_id" class="form-label">工具ID *</label>
                        <input type="text" class="form-control" id="tool_id" name="tool_id" required>
                        <div class="form-text">工具的唯一标识符，建议使用英文字母和下划线</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="tool_name" class="form-label">工具名称 *</label>
                        <input type="text" class="form-control" id="tool_name" name="name" required>
                        <div class="form-text">工具的显示名称</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="tool_description" class="form-label">工具描述 *</label>
                        <textarea class="form-control" id="tool_description" name="description" rows="3" required></textarea>
                        <div class="form-text">详细描述工具的功能和用途</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="command_template" class="form-label">命令模板 *</label>
                        <textarea class="form-control" id="command_template" name="command_template" rows="4" required></textarea>
                        <div class="form-text">
                            工具执行时使用的命令模板，可以使用变量占位符，如 {param1}, {param2}
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb"></i> 
                        <strong>提示:</strong> 命令模板中可以使用大括号包裹的变量名作为参数占位符，
                        例如: <code>echo "Hello {name}, today is {date}"</code>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 保存工具
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                确定要删除这个工具吗？删除后正在使用此工具的任务可能会失效。
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">确认删除</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentToolId = null;

function editTool(toolId = null, toolData = null) {
    const modal = document.getElementById('toolModal');
    const title = document.getElementById('toolModalTitle');
    
    if (toolId && toolData) {
        // 编辑模式
        title.textContent = '编辑工具';
        document.getElementById('tool_id').value = toolId;
        document.getElementById('tool_id').readOnly = true;
        document.getElementById('tool_name').value = toolData.name;
        document.getElementById('tool_description').value = toolData.description;
        document.getElementById('command_template').value = toolData.command_template;
    } else {
        // 新增模式
        title.textContent = '新增工具';
        document.getElementById('tool_id').value = '';
        document.getElementById('tool_id').readOnly = false;
        document.getElementById('tool_name').value = '';
        document.getElementById('tool_description').value = '';
        document.getElementById('command_template').value = '';
    }
}

function deleteTool(toolId) {
    currentToolId = toolId;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

function confirmDelete() {
    if (currentToolId) {
        // 创建隐藏表单提交删除请求
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/tool/${currentToolId}/delete`;
        document.body.appendChild(form);
        form.submit();
    }
}

// 表单验证
document.querySelector('#toolModal form').addEventListener('submit', function(e) {
    const toolId = document.getElementById('tool_id').value.trim();
    const toolName = document.getElementById('tool_name').value.trim();
    const description = document.getElementById('tool_description').value.trim();
    const commandTemplate = document.getElementById('command_template').value.trim();
    
    if (!toolId || !toolName || !description || !commandTemplate) {
        e.preventDefault();
        alert('请填写所有必需字段');
        return false;
    }
    
    // 验证工具ID格式
    if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(toolId)) {
        e.preventDefault();
        alert('工具ID只能包含字母、数字和下划线，且必须以字母或下划线开头');
        return false;
    }
});
</script>
{% endblock %}